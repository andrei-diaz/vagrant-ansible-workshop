---
# Database Server - PostgreSQL + pgAdmin
# Taller Vagrant + Ansible

- name: "游냊 POSTGRESQL: Configuraci칩n del servidor de base de datos"
  hosts: database
  become: yes
  vars:
    postgres_version: "15"
    db_name: "examenes_db"
    db_user: "examenes_user"
    db_password: "examenes_password_123"
    
  tasks:
    - name: Instalar repositorio oficial de PostgreSQL
      apt:
        deb: "https://ftp.postgresql.org/pub/pgdg/repos/apt/pool/main/p/postgresql-common/postgresql-common_248.pgdg22.04+1_all.deb"
        state: present
      ignore_errors: yes

    - name: Agregar clave GPG de PostgreSQL
      apt_key:
        url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
        state: present

    - name: Agregar repositorio de PostgreSQL
      apt_repository:
        repo: "deb http://apt.postgresql.org/pub/repos/apt/ {{ ansible_distribution_release }}-pgdg main"
        state: present

    - name: Actualizar cache de paquetes
      apt:
        update_cache: yes

    - name: Instalar PostgreSQL y dependencias
      apt:
        name:
          - "postgresql-{{ postgres_version }}"
          - "postgresql-client-{{ postgres_version }}"
          - postgresql-contrib
          - python3-psycopg2
          - python3-pip
        state: present

    - name: Instalar pip packages para PostgreSQL
      pip:
        name:
          - psycopg2-binary
        state: present

    - name: Iniciar y habilitar PostgreSQL
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: Configurar PostgreSQL para escuchar en todas las interfaces
      lineinfile:
        path: "/etc/postgresql/{{ postgres_version }}/main/postgresql.conf"
        regexp: "^#?listen_addresses"
        line: "listen_addresses = '*'"
        backup: yes
      notify: restart postgresql

    - name: Configurar autenticaci칩n para conexiones remotas
      lineinfile:
        path: "/etc/postgresql/{{ postgres_version }}/main/pg_hba.conf"
        line: "host    all             all             192.168.56.0/24         md5"
        backup: yes
      notify: restart postgresql

    - name: Crear base de datos para el sistema de ex치menes
      shell: sudo -u postgres createdb -E UTF8 -T template0 {{ db_name }}
      ignore_errors: yes

    - name: Crear usuario de base de datos
      shell: sudo -u postgres psql -c "CREATE USER {{ db_user }} WITH PASSWORD '{{ db_password }}';"
      ignore_errors: yes

    - name: Otorgar privilegios al usuario de la aplicaci칩n
      shell: |
        sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};"
        sudo -u postgres psql -c "ALTER USER {{ db_user }} CREATEDB;"
      ignore_errors: yes

    - name: Crear script SQL de inicializaci칩n
      copy:
        dest: /tmp/init_examenes_db.sql
        content: |
          -- Script de inicializaci칩n para Sistema de Ex치menes M칠dicos
          -- Base de datos: {{ db_name }}
          
          -- Crear extensiones 칰tiles
          CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
          CREATE EXTENSION IF NOT EXISTS "pg_trgm";
          
          -- Crear tabla de usuarios (estructura CakePHP)
          CREATE TABLE IF NOT EXISTS users (
              id SERIAL PRIMARY KEY,
              email VARCHAR(255) NOT NULL UNIQUE,
              password VARCHAR(255) NOT NULL,
              role VARCHAR(50) DEFAULT 'estudiante',
              active BOOLEAN DEFAULT true,
              created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          -- Crear tabla de reactivos (preguntas del examen)
          CREATE TABLE IF NOT EXISTS reactivos (
              id SERIAL PRIMARY KEY,
              pregunta TEXT NOT NULL,
              respuesta_a VARCHAR(500) NOT NULL,
              respuesta_b VARCHAR(500) NOT NULL,
              respuesta_c VARCHAR(500) NOT NULL,
              respuesta_correcta CHAR(1) NOT NULL CHECK (respuesta_correcta IN ('a', 'b', 'c')),
              retroalimentacion TEXT,
              dificultad VARCHAR(20) DEFAULT 'medio' CHECK (dificultad IN ('facil', 'medio', 'dificil')),
              area_especialidad VARCHAR(100),
              subespecialidad VARCHAR(100),
              user_id INTEGER REFERENCES users(id),
              created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          -- Crear tabla de ex치menes
          CREATE TABLE IF NOT EXISTS examenes (
              id SERIAL PRIMARY KEY,
              nombre VARCHAR(255) NOT NULL,
              descripcion TEXT,
              tiempo_limite INTEGER DEFAULT 120, -- minutos
              numero_preguntas INTEGER DEFAULT 50,
              activo BOOLEAN DEFAULT true,
              created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          -- Insertar usuario administrador por defecto
          INSERT INTO users (email, password, role, active) VALUES 
          ('admin@examenes.com', crypt('admin123', gen_salt('bf')), 'administrador', true)
          ON CONFLICT (email) DO NOTHING;
          
          -- Insertar datos de prueba para reactivos
          INSERT INTO reactivos (pregunta, respuesta_a, respuesta_b, respuesta_c, respuesta_correcta, area_especialidad, subespecialidad, user_id) VALUES
          ('쮺u치l es la dosis inicial recomendada de aspirina para prevenci칩n cardiovascular?', '75-100 mg/d칤a', '200-300 mg/d칤a', '500-1000 mg/d칤a', 'a', 'Medicina Interna', 'Cardiolog칤a', 1),
          ('쮺u치l es el signo patognom칩nico de apendicitis aguda?', 'Signo de McBurney', 'Signo de Murphy', 'Signo de Rovsing', 'a', 'Cirug칤a', 'Cirug칤a General', 1),
          ('쮸 qu칠 edad se recomienda iniciar el tamizaje de c치ncer cervicouterino?', '18 a침os', '21 a침os', '25 a침os', 'b', 'Ginecolog칤a', 'Oncolog칤a Ginecol칩gica', 1)
          ON CONFLICT DO NOTHING;

    - name: Ejecutar script de inicializaci칩n
      shell: sudo -u postgres psql -d {{ db_name }} -f /tmp/init_examenes_db.sql
      ignore_errors: yes

    - name: Configurar backup autom치tico
      cron:
        name: "Backup diario base de datos examenes"
        minute: "0"
        hour: "2"
        job: "pg_dump {{ db_name }} | gzip > /var/backups/examenes_$(date +\\%Y\\%m\\%d).sql.gz"
        user: postgres

    - name: Crear directorio de backups
      file:
        path: /var/backups
        state: directory
        owner: postgres
        group: postgres
        mode: '0755'

    - name: Mostrar informaci칩n de la base de datos
      debug:
        msg: |
          ==========================================
          游냊 POSTGRESQL CONFIGURADO
          ==========================================
          游늵 Base de datos: {{ db_name }}
          游녻 Usuario: {{ db_user }}
          游댋 Puerto: 5432
          游깷 Acceso: 192.168.56.30:5432
          ==========================================

  handlers:
    - name: restart postgresql
      systemd:
        name: postgresql
        state: restarted